=== database commands to fix it for "karchangame" in ejb mode ===

drop table mm_boardmessages2;

create table mm_boardmessages2 (
  id bigint(20) NOT NULL AUTO_INCREMENT primary key,
  boardid int(11) NOT NULL,
  name varchar(20) NOT NULL DEFAULT '',
  posttime timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  message text not null,
  removed int(1) not null default 0,
  UNIQUE INDEX natural_key (boardid, name, posttime),
  foreign key (boardid) references mm_boards (id),
  CONSTRAINT FOREIGN KEY (`name`) REFERENCES
  `mm_usertable` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


insert into mm_boardmessages2
(boardid, name, posttime, message, removed)
select *
from mm_boardmessages
where exists (select * from mm_usertable
where name = mm_boardmessages.name)
order by posttime;

rename table mm_boardmessages to mm_boardmessages_old;
rename table mm_boardmessages2 to mm_boardmessages;

update mm_usertable set birth = null where birth = "0000-00-00 00:00:00";

alter table mm_usertable change room room int(7) not null default 1;
alter table mm_usertable
add foreign key (room) references mm_rooms (id);

// already done in current database

----
drop table mm_boardmessages_old;

ALTER TABLE mm_usertable CHANGE state currentstate text;
ALTER TABLE mm_usertable CHANGE creation creation_date timestamp not null
default current_timestamp;
ALTER TABLE mm_usertable CHANGE length height varchar(20);

# add trigger
/home/maartenl/Land-of-Karchan/sqlscripts/triggers/mm_usertable_insert_trigger.sql

# change the log (mm_log)
drop table mm_log2;

create table mm_log2 (
  id bigint(20) NOT NULL AUTO_INCREMENT primary key,
  creation_date timestamp not null,
  name varchar(20),
  message text not null,
  addendum text
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

create index natural_index on mm_log2 (creation_date, name);


insert into mm_log2
(creation_date, name, message, addendum)
select *
from mm_log
order by creation, name, message;

rename table mm_log to mm_log_old;
rename table mm_log2 to mm_log;

drop table mm_log_old;

ALTER TABLE mm_usertable ADD lastcommand timestamp;
update mm_usertable set lastcommand = null;
